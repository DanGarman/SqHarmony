# Squinktronix Harmony manual

Harmony is a very simple module (on the outside). It takes a single input of a root pitch, and outputs a four part harmony. Harmony attempts to link chords together using the common practice rules for voice leading, as described in Walter Piston's classic text "Harmony".  

If the output is used to play a four voice polyphonic synth patch, it will sound more or less like "music from right before Bach". You don't need to know anything about music theory to use it, however.

Historic trivia: this is the first program I wrote when I got a C++ compiler, which was probably 1991 with Borland C++ 2.0. Over the years the code has been updated a little bit, mostly to make it faster. Porting it to VCV necessitated some changes and compromises, as it is now a real-time module, whereas in the past it was allowed to backtrack when it couldn't link chords. Now that's impossible, and some compromises needed to be introduced.

## Panel

### The score at the top

This displays the last bar or two of generated chords. It is purely visual candy. If you don't read music, don't worry about it.

All durations are notated as quarter notes. The module has no conception of "time", so this is completely arbitrary. I like the way notes look with stems, so that's what I did.

Because the chords generated by Harmony are fairly "simple", the notation often comes out looking pretty good. But there are probably ways to make the stems run into each other or something else bad.

### The input

There is a single CV input. It's monophonic, and follows the VCV voltage standards. The input is quantized to the current scale. If it has changed, new output is generated.

The input is used to determine which chord to generate, 1, 2, 3, 4, 5, 6, or 7. The octave information is ignored. Also ignored are any non-scale notes in the input, they are quantized to the nearest scale note.

### The outputs

There are four CV outputs. They are also monophonic, and there is one for each outputs voice: bass, tenor, alto, and soprano.

## Getting good results

Harmony tries to output decent chord progressions regardless of the input. So you feed anything into it and get a plausible output. But if you want it to sound "right" to ears from 1700, you need to spend a little care with the input.

For example, you can patch a knob into the CV input, twist the knob, and get out a sequence of chords. But they won't get great sounding. This is because Harmony will see that your are entering a chord progression of 1, 2, 3, 4, 5, 6 etc.. which is not a chord progression that works well with common practice harmony. It is very difficult to connect this "bizarre" chord progression without breaking any rule.

A chord progression of 1-5 is super easy to connect, but 1,2,3,4,5 is very difficult. So try to apply clean, discrete input to Harmony, not slowly changing input. Even if the input moves fast enough that you don't hear 1,2,3,4,5 Harmony heard it and tried to harmonize it. When you settle on the 5 Harmony may have take a tortuous path to get there, and the result won't sound as good as a clean 1-5 input.

## Current Limitations

It is always in C Major. I intend to make it support all the diatonic roots/modes, but have not yet because:

* I want to get it working ok in CMaj first.
* The harmony rules it has are really for major keys. Some rules won't apply to other modes. But I think that will be OK.
* I will need to put the keysig into the notation window.

Other limitations:

* The input quantizer may not work super well with messy input.
* No panel design.
* The score window is probably a GPU hog. I can easily improve this.
* When a change is detected on the input a lot of code runs. May cause clicks and pops with low buffer settings.

## How it works, and what rules does it know

Every time Harmony sees a new note it takes that new note as the scale degree of a chord to be generated. The chord is supposed to sound good following the previous chord.

So Harmony picks chords that it can "legally" make from that scale degree. It evaluates the chord in the context of the previous chord. The first one that doesn't break any rules for voice leading is then used.

The chords may be in any inversion. They will be major, minor or diminished triads, as only one will follow the key signature without accidentals.

The criteria for a valid chord:

* Each triad chord tone (1, 3, 5) is in the chord at least once.
* The chords are always triads, with one voice doubled. i.e. they are never 7th chords.
* The four voices of the chord are in the generally allowable ranges of those voices (bass, tenor, alto, soprano).

The rules:

Many of these rules are from Piston's Harmony. A few are ad-hoc, or from some other source.

* Chords should not repeat exactly the same as they were two steps back. ex: if the progression is 1-5-1, the two 1 chords should be voiced different.
* For any pair of chords, one of them should be in root position. This could be a user setting.
* A leading tone (7th) in a chord must either ascend to the 1, or descend. In addition, in a 5-1 or 5-6 progression a leading tone in the soprano must must ascend to the 1.
* Parallel fifths and octaves are bad. As are direct fifths and octaves arrived at via similar motion.
* No voice can cross another voice.
* All voices should not move in the same direction.
* When the two chords have no notes in common (like a IV-V progression), then the three top voices should move in one direction, and the bass voice should move in the other direction. All voices should move to the closest scale degree. (this rule is why 1,2,3,4 progressions are so hard for Harmony).
* Doubling:
  * Chords in root position should double the root.
  * Chords in first inversion should double the third (bass).
  * Chords in second inversion should double the fifth (bass).
  * (There are less restrictive rules around this - something to investigate).
* No voice should "jump" more than 12 scale degrees. (I think this is a typo, and should be an octave instead).

If the progression is an "easy" one, a chord might be quickly found that passes all the rules. In other cases Harmony might have to look at a lot of possibilities to find a good one. It may be that all the chords break a rule, and there is none that can pass. In that case the "best" one is picked.

ATM, all the rules have equal weight, except for the voice doubling rule, it has slightly less weight, so if Harmony can't find a perfect chord it would prefer one with "illegal" doubling over violating the other rules. Also, the penalty from each rule is added, so Harmony prefers to violate as few rules as possible.
